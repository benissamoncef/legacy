#
#  FICHIER: $Id: Makefile_linux64,v 1.1 2018/02/20 19:18:22 devgfi Exp $		$Revision: 1.1 $	$Date: 2018/02/20 19:18:22 $
#
#  Ce fichier est dependant des variables d'environnement :
#  $HOME, $RTHOME, $SYBASE
#
###################################################################
# ESCOTA *  PROJET MIGRAZUR
###################################################################
# SOUS-SYSTEME  GECONF
###################################################################
#
# HISTORIQUE :
#
# JPL	20/02/18 : Creation d'apres Makefile V1.14 (DEM 1274)  1.1
###################################################################
#
# Inhibition de l'echo des commandes
#
.SILENT:
#
# Ajout des suffixes de fichiers concernes
#
#.SUFFIXES: .sc
#
##################################################################
#
# nom du sous systeme
#

SSYST = GECONF
PROJHOME = $(HOME)/migrazur
TIBEMS_DIR=/opt/tibco/ems/8.5/

#
# Definitions des chemins d'acces
#

DIRSRC = $(CI_PROJECT_DIR)/$(SSYST)/src
DIREXE = $(CI_PROJECT_DIR)/$(SSYST)/binx64EMS
DIRLIB = $(CI_PROJECT_DIR)/$(SSYST)/libx64EMS
DIRINC = $(CI_PROJECT_DIR)/$(SSYST)/inc

RTINCLUDE = $(RTHOME)/include
SYBINCLUDE = $(SYBASE)/$(SYBASE_OCS)/include

#
# 64-bit libs
#
TIBEMS_LIB64=-ltibems64 -ltibemslookup64
TIBEMSUFO_LIB64=-ltibemsufo64
TIBEMSADMIN_LIB64=-ltibemsadmin64
TIBEMS_SSL_LIB64=-lssl -lcrypto
TIBEMS_LDAP_LIB64=-lldap -llber
TIBEMS_XML_LIB64=-lxml2
TIBEMS_ZLIB64=-lz
TLIBS=-lpthread

LIBS=$(TIBEMS_LIB64) \
     $(TIBEMSADMIN_LIB64) $(TIBEMS_LDAP_LIB64) $(TIBEMS_XML_LIB64) $(TIBEMS_SSL_LIB64) $(TIBEMS_ZLIB64) $(TLIBS) \
          $(TIBEMSUFO_LIB64)


EMS_LIB=-L/opt/tibco/ems/8.5/lib/64 -L/opt/tibco/ems/8.5/lib $(LIBS)

# Paths  communs

XDMICGINC = $(CI_PROJECT_DIR)/XDMICG/inc
XDMICGLIB = $(CI_PROJECT_DIR)/XDMICG/libx64EMS


#
# Definition des flags de compilation et de correcteur syntaxique
#

RTLINK = $(RTHOME)/bin/rtlink  -64bit


# compilateur
#CC = purify cc
CC = cc
# -verbose


CFLAGS = -g -m64\
	-D_TIBCO_EMS\
	-D_XOPEN_SOURCE=500\
	-DSYB_LP64\
	-I$(RTINCLUDE)\
	-I$(SYBINCLUDE)\
	-I$(XDMICGINC)\
	-I$(DIRINC)\
	-I$(TIBEMS_DIR)\include


OPTLINT=no
#LINT = $(LINTDIR)/lint

LFLAGS = -u\
	-I$(RTHOME)\
	-L/opt/tibco/ems/8.5/lib/64\
	-L/opt/tibco/ems/8.5/lib\
	-I$(TIBEMS_DIR)


# Librairies SmartSockets
#RT_PATH_LIB = $(RTHOME)/lib/$(RTARCH)/lib64
#RT_LIB      = -lrtutil -lrtipc
#LDRTWORKS = -L$(RT_PATH_LIB)  $(RT_LIB)


# Librairies SYBASE
SYBASE_PATH_LIB = $(SYBASE)/$(SYBASE_OCS)/lib
SYBASE_LIB = -lsybtcl64 -lsybcs64 -lsybcomn64 -lsybintl64 -lsybunic64
LDSYBASE = -L$(SYBASE_PATH_LIB)  -lsybct64  $(SYBASE_LIB)



# librairies communes applicatives utilisees

LIB_C =  $(XDMICGLIB)/xzs.a \
	$(XDMICGLIB)/xze.a \
	$(XDMICGLIB)/xza.a \
	$(XDMICGLIB)/xzc.a \
	$(XDMICGLIB)/xzaoa.a \
	$(XDMICGLIB)/xzaol.a \
	$(XDMICGLIB)/xzaoc.a \
	$(XDMICGLIB)/xzd.a \
	$(XDMICGLIB)/xzi.a \
	$(XDMICGLIB)/xd.a \
	$(XDMICGLIB)/xzi.a



########### Zone a modifier par le developpeur ################
#
# DEFINITION DES SOURCES D'UNE  TACHE
#


# LES INCLUDES de tcgcd.x
INC_CGCD = $(DIRINC)/cgcd_dir.h \
	$(DIRINC)/cgcd_mvf.h \
	$(DIRINC)/cgcd_mvf_2.h \
	$(DIRINC)/cgcd_mvf_3.h \
	$(DIRINC)/cgcd_msr.h \
	$(DIRINC)/cgcd_mSGBDma.h \
	$(DIRINC)/cgcd_mSGBDeq.h \
	$(DIRINC)/cgcd_mSGBDihm.h \
	$(DIRINC)/cgcd_mSGBDty.h \
	$(DIRINC)/cgcd_mvf_util.h \
	$(DIRINC)/cgcd_liv.h \
	$(DIRINC)/cgcd_dif.h \
	$(DIRINC)/cgcd_vce.h \
	$(DIRINC)/cgcd_util.h \
	$(XDMICGINC)/xdg.h\
	$(XDMICGINC)/xzsm.h\
	$(XDMICGINC)/xzcg.h\
	$(XDMICGINC)/xdc.h\
	$(XDMICGINC)/xdy.h\
	$(XDMICGINC)/xzia.h\
	$(XDMICGINC)/xzao.h



# LES SOURCES de tcgcd.x
SRC_CGCD = $(DIRSRC)/cgcd_dir.c\
	 $(DIRSRC)/cgcd_mvf.c\
	 $(DIRSRC)/cgcd_mvf_2.c\
	 $(DIRSRC)/cgcd_mvf_3.c\
	 $(DIRSRC)/cgcd_msr.c\
	 $(DIRSRC)/cgcd_mSGBDma.c\
	 $(DIRSRC)/cgcd_mSGBDeq.c\
	 $(DIRSRC)/cgcd_mSGBDihm.c\
	 $(DIRSRC)/cgcd_mSGBDty.c\
	 $(DIRSRC)/cgcd_mvf_util.c\
	 $(DIRSRC)/cgcd_liv.c\
	 $(DIRSRC)/cgcd_dif.c\
	 $(DIRSRC)/cgcd_vce.c\
	 $(DIRSRC)/cgcd_util.c



# LES SOURCES des Shell scripts
SRC_SHELL1 = $(DIRSRC)/cgcd_ApDif.sh

SRC_SHELL2 = $(DIRSRC)/cgcd_mtrf.sh

SRC_SHELL3 = $(DIRSRC)/tcsvm.ksh



#
# Librairie d'un executable
#

OBJ_CGCD =  $(DIRLIB)/tcgcd.a



#
# DEFINITION DU NOM DES EXECUTABLES
#

EXE_CGCD = $(DIREXE)/tcgcd.x

EXE_SHELL1 = $(DIREXE)/cgcd_ApDif.sh
EXE_SHELL2 = $(DIREXE)/cgcd_mtrf.sh
EXE_SHELL3 = $(DIREXE)/tcsvm.ksh

EXE =  $(EXE_CGCD) $(EXE_SHELL1) $(EXE_SHELL2) $(EXE_SHELL3)



#
# DEFINITION DES REGLES DE GENERATION
#
# Premiere regle il faut tout faire : les communs et les executables

tout : $(EXE)
	echo
	@echo LE SOUS-SYSTEME $(SSYST) EST A JOUR.
	echo


#
# GENERATION  D'UN EXECUTABLE
#
# Phase edition de lien
#

# TCGCD
$(EXE_CGCD) : $(SRC_CGCD) $(OBJ_CGCD)
	echo
	echo "PHASE EDITION DE LIEN :"$@
	echo $(CC)  $(CFLAGS)  $(OBJ_CGCD) $(LIB_C) $(EMS_LIB)  $(LDRTWORKS)  $(LDSYBASE)  -o $@
	$(CC)  $(CFLAGS)  $(OBJ_CGCD) $(LIB_C) $(EMS_LIB)  $(LDRTWORKS)  $(LDSYBASE)  -o $@
	echo
	echo "TAILLE DE L'EXECUTABLE :"$@
	@size $@
	@echo Executable $@ a jour.


# Passage des script Shell de src a bin en gardant les bons droits
$(EXE_SHELL1) : $(SRC_SHELL1)
	echo
	echo "Mise a jour de :"$@
	echo
	rm -f $(EXE_SHELL1)
	cp  $(SRC_SHELL1) $(EXE_SHELL1)
	echo "Droits en execution donnes a "$@
	echo
	chmod +wx $(EXE_SHELL1)

$(EXE_SHELL2) : $(SRC_SHELL2)
	echo
	echo "Mise a jour de :"$@
	echo
	rm -f $(EXE_SHELL2)
	cp  $(SRC_SHELL2) $(EXE_SHELL2)
	echo "Droits en execution donnes a "$@
	echo
	chmod +wx $(EXE_SHELL2)

$(EXE_SHELL3) : $(SRC_SHELL3)
	echo
	echo "Mise a jour de :"$@
	echo
	rm -f $(EXE_SHELL3)
	cp  $(SRC_SHELL3) $(EXE_SHELL3)
	echo "Droits en execution donnes a "$@
	echo
	chmod +wx $(EXE_SHELL3)


#
# Regle liant les sources aux fichiers include communs
#
# TCGCD
#$(SRC_CGCD) : $(INC_CGCD)
#	touch $@

#
# Description des composants de la librairie TCGCD
#

$(OBJ_CGCD):\
	$(OBJ_CGCD)(cgcd_dir.o)\
	$(OBJ_CGCD)(cgcd_mvf.o)\
	$(OBJ_CGCD)(cgcd_mvf_2.o)\
	$(OBJ_CGCD)(cgcd_mvf_3.o)\
	$(OBJ_CGCD)(cgcd_msr.o)\
	$(OBJ_CGCD)(cgcd_mSGBDma.o)\
	$(OBJ_CGCD)(cgcd_mSGBDeq.o)\
	$(OBJ_CGCD)(cgcd_mSGBDihm.o)\
	$(OBJ_CGCD)(cgcd_mSGBDty.o)\
	$(OBJ_CGCD)(cgcd_mvf_util.o)\
	$(OBJ_CGCD)(cgcd_liv.o)\
	$(OBJ_CGCD)(cgcd_dif.o)\
	$(OBJ_CGCD)(cgcd_vce.o)\
	$(OBJ_CGCD)(cgcd_util.o)



#
# GENERATION  D'UN EXECUTABLE  RTWORKS
#
# Phase edition de lien
#

#$(EXE) : $(SRC) $(OBJ) $(LIB)
#	echo
#	echo "PHASE EDITION DE LIEN :"$@
#	$(RTLINK)  $(OBJ) $(LIB)  -o $@
#	echo
#	echo "TAILLE DE L'EXECUTABLE :"$@
#	@size $@
#	@echo Executable $@ a jour.


########### Fin de zone a modifier par le developpeur ################

#
# phase de menage du makefile
#
clean:
	rm -f $(DIRLIB)/*.a
	rm -f $(EXE)

#
#
# Redefinition de la regles de construction d'un .o a partir d'un .c
#
#
.c.o :
	echo " "
	if test $(OPTLINT) = yes;\
          then echo "PHASE DE VERIFICATION SYNTAXIQUE : "   $<;\
               $(LINT) $(LFLAGS)  $<;\
          else echo $< "PAS DE VERIFICATION SYNTAXIQUE ";\
        fi;
	echo
	echo "PHASE DE COMPILATION             : "   $<
	echo " "
	$(CC)   $(CFLAGS) -c $<

#
# Redefinition de la regles de construction d'un .a a partir d'un .o
#
.o.a:
	echo "CREATION DE LIBRAIRIE "$@.a
	ar rv $@.a $<
	touch $@.a
	rm -f $<

#
# Redefinition de la regles de construction d'un .a a partir d'un .c
#
.c.a :
	echo " "
	if test $(OPTLINT) = yes;\
          then echo "PHASE DE VERIFICATION SYNTAXIQUE : "   $*.c;\
               $(LINT) $(LFLAGS)  $*.c;\
          else echo  "PAS DE VERIFICATION SYNTAXIQUE " $*.c;\
        fi;
	echo
	echo "PHASE DE COMPILATION             : "   $*.c
	echo " "
	$(CC)   $(CFLAGS) -c $*.c
	echo "MISE A JOUR DE LIBRAIRIE :"$@
	ar r $@ $*.o
	touch $@
	rm -f $*.o

