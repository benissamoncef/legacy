#!/bin/ksh
#
#       -- Script d'arret de l'application MIGRAZUR
#               sur un SD ou SC ACTIF (SDCI1, SDDN1, SDDM1)
#
set -x

site="XX"

# tester le nom du site
if [[ `hostname` = "SDCI1" ]]
then
site="CI"
fi

if [[ `hostname` = "SDDN1" ]]
then
site="DN"
fi

if [[ `hostname` = "SDDM1" ]]
then
site="DM"
fi

if [[ `hostname` = "PODC1" ]]
then
site="DC"
fi

if [[ `hostname` = "PODS1" ]]
then
site="DS"
fi

if [[ `hostname` = "SDDA1" ]]
then
site="DA"
fi

if [[ `hostname` = "SDDC1" ]]
then
site="DC"
fi

if [[ `hostname` = "SDDS1" ]]
then
site="DS"
fi

if [[ `hostname` = "PODY1" ]]
then
site="DY"
fi

if [[ `hostname` = "PODP1" ]]
then
site="DP"
fi


if [[ $site = "XX" ]]
then
exit 1
fi

. /produits/migrazur/appliSD/.profile


echo "shutdown
go" | isql -Usa -Pzigramur -SREP_${site}


echo "shutdown
go" | isql -Usa -Pzigramur -S${site}_RSSD_LTM

echo "shutdown
go" | isql -Usa -Pzigramur -S${site}_EXP_LTM

if [[ $site = "CI" ]] || if [[ $site = "CA" ]]
then
echo "shutdown
go" | isql -Usa -Pzigramur -S${site}_CFG_LTM
fi

echo "shutdown 
go" | isql -Usa -Pzigramur -SSQL_${site} >>/dev/null 2>>/dev/null &


ps -umigrazur |
while read pid tty time cmd rest; do
[[ "$cmd" = tsaplg.x || "$cmd" = axnet ]] &&
        kill -9 $pid
done

ps -umigrazur |
while read pid tty time cmd rest; do
[[ "$cmd" = tacli.x || "$cmd" = tacpc.x || "$cmd" = taeqa.x || "$cmd" = tapur.x || "$cmd" = tasrv.x || "$cmd" = teini.x ]] &&
        kill $pid
done

sleep 20

ps -umigrazur |
while read pid tty time cmd rest; do
[[ "$cmd" != COMMAND ]] &&
        kill $pid
done

rtserver -stop
rtlm -stop
